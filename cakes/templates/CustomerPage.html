{% extends "base.html" %}

{% block title %}Our Cakes - FynCakes{% endblock %}

{% block head_extra %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/customer.css') }}">
{% endblock %}

{% block content %}
<div class="customer-container" 
     id="customer-container-data"
     data-current-page="{{ current_page }}"
     data-total-pages="{{ total_pages }}"
     data-selected-category="{{ selected_category or '' }}"
     data-search-query="{{ search_query or '' }}">

    <h1 class="page-title">
        {% if selected_category %}{{ selected_category }}{% elif search_query %}Results for "{{ search_query }}"{% else %}Our Cakes{% endif %}
    </h1>

    <div class="category-dropdown-container">
        <label for="category-select">Select a Category:</label>
        <select id="category-select" class="category-dropdown" onchange="window.location.href=this.value;">
            <option value="{{ url_for('routes.customer') }}" {% if not selected_category %}selected{% endif %}>
                All Cakes
            </option>
            {% for category in categories %}
            <option value="{{ url_for('routes.customer', category=category) }}" {% if category == selected_category %}selected{% endif %}>
                {{ category }}
            </option>
            {% endfor %}
        </select>
    </div>

    <div class="shop-layout">
        <main>
            <form action="{{ url_for('routes.customer') }}" method="GET" class="search-bar-container">
                <input type="search" name="q" class="search-input" placeholder="Search for cakes..." value="{{ search_query or '' }}">
                <button type="submit" class="search-button">
                    <i class="fas fa-search"></i>
                </button>
            </form>

            <div class="product-grid" id="product-grid">
                {% if cakes %}
                    {% for cake in cakes %}
                    <a href="{{ url_for('routes.cake_details', cake_id=cake._id) }}" class="cake-card-link">
                        <div class="cake-card">
                            <div class="cake-card-image">
                                <img src="{{ cake.image }}" alt="{{ cake.name }}">
                            </div>
                            <div class="cake-card-content">
                                <h3>{{ cake.name }}</h3>
                                <p>{{ cake.description }}</p>
                                <p class="price">${{ "%.2f"|format(cake.price) }}</p>
                                <div class="order-button-wrapper">
                                    <span class="order-button">
                                        <i class="fas fa-search-plus"></i> View Details
                                    </span>
                                </div>
                            </div>
                        </div>
                    </a>
                    {% endfor %}
                {% else %}
                    <div class="no-cakes-message">
                        <h2>No cakes found.</h2>
                        <p>Try clearing your search or selecting another category. View <a href="{{ url_for('routes.customer') }}">all our cakes</a>.</p>
                    </div>
                {% endif %}
            </div>

            <div class="see-more-container {% if current_page >= total_pages %}hidden{% endif %}" id="see-more-container">
                <button class="see-more-btn" id="see-more-btn">See More</button>
                <div class="loader" id="loader" style="display: none;"></div>
            </div>
        </main>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const dataContainer = document.getElementById('customer-container-data');
    let currentPage = parseInt(dataContainer.dataset.currentPage);
    const totalPages = parseInt(dataContainer.dataset.totalPages);
    const selectedCategory = dataContainer.dataset.selectedCategory;
    const searchQuery = dataContainer.dataset.searchQuery;

    const seeMoreBtn = document.getElementById('see-more-btn');
    const loader = document.getElementById('loader');
    const container = document.getElementById('product-grid');
    const seeMoreContainer = document.getElementById('see-more-container');

    if (seeMoreBtn) {
        seeMoreBtn.addEventListener('click', async () => {
            currentPage++;
            
            loader.style.display = 'block';
            seeMoreBtn.style.display = 'none';

            try {
                let apiUrl = `/api/get_cakes?page=${currentPage}`;
                if (selectedCategory) {
                    apiUrl += `&category=${encodeURIComponent(selectedCategory)}`;
                }
                if (searchQuery) {
                    apiUrl += `&q=${encodeURIComponent(searchQuery)}`;
                }

                const response = await fetch(apiUrl);
                const newCakes = await response.json();

                if (newCakes.length > 0) {
                    newCakes.forEach(cake => {
                        const cakeCardHTML = `
                        <a href="${cake.url}" class="cake-card-link">
                            <div class="cake-card">
                                <div class="cake-card-image">
                                    <img src="${cake.image}" alt="${cake.name}">
                                </div>
                                <div class="cake-card-content">
                                    <h3>${cake.name}</h3>
                                    <p>${cake.description}</p>
                                    <p class="price">$Shs{parseFloat(cake.price).toFixed(2)}</p>
                                    <div class="order-button-wrapper">
                                        <span class="order-button">
                                            <i class="fas fa-search-plus"></i> View Details
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </a>
                        `;
                        container.insertAdjacentHTML('beforeend', cakeCardHTML);
                    });
                }
                
                if (currentPage >= totalPages) {
                    seeMoreContainer.style.display = 'none';
                }

            } catch (error) {
                console.error('Failed to load more cakes:', error);
            } finally {
                loader.style.display = 'none';
                if (currentPage < totalPages) {
                    seeMoreBtn.style.display = 'block';
                }
            }
        });
    }
</script>
{% endblock %}