{% extends "base.html" %}

{% block title %}Our Cakes - FynCakes{% endblock %}

{% block head_extra %}
    <!-- All styling is now correctly handled by the external CSS file -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/customer.css') }}">
{% endblock %}

{% block content %}
<!--
THE FIX: We pass data from the server to JavaScript using data-* attributes.
This is a clean and safe way to avoid syntax errors.
-->
<div class="customer-container" 
     id="customer-container-data"
     data-current-page="{{ current_page }}"
     data-total-pages="{{ total_pages }}"
     data-login-url="{{ url_for('routes.login', next=request.path) }}"
     data-add-to-cart-url="{{ url_for('routes.add_to_cart_db') }}">

    <h1 class="page-title">Our Cakes</h1>

    <!-- The container where cakes are displayed -->
    <div class="cake-container" id="cake-container">
        <!-- Initially populated with the first page of cakes from the server -->
        {% for cake in cakes %}
        <div class="cake-card">
            <div class="cake-card-image">
                <img src="{{ cake.image }}" alt="{{ cake.name }}">
            </div>
            <div class="cake-card-content">
                <h3>{{ cake.name }}</h3>
                <p>{{ cake.description }}</p>
                <p class="price">${{ "%.2f"|format(cake.price) }}</p>
                <button
                    class="order-button"
                    data-name="{{ cake.name }}"
                    data-image="{{ cake.image }}"
                    data-price="{{ cake.price }}"
                    data-description="{{ cake.description }}"
                    onclick="addToCart(this)"
                >
                    <i class="fas fa-shopping-cart"></i> Add to Cart
                </button>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Message shown if no cakes have been uploaded yet -->
    {% if not cakes %}
    <div class="no-cakes-message">
        <h2>Our bakers are busy!</h2>
        <p>There are currently no cakes available. Please check back soon!</p>
    </div>
    {% endif %}

    <!-- The "Load More" button container. The display is now controlled by a class. -->
    <div class="load-more-container {% if current_page >= total_pages %}hidden{% endif %}" id="load-more-container">
        <button class="load-more-btn" id="load-more-btn">Load More Cakes</button>
        <div class="loader" id="loader" style="display: none;"></div>
    </div>

</div>
{% endblock %}

{% block scripts %}
<!-- This script block contains the page's functional logic -->
<script>
    // THE FIX: We safely read the data from our container's `dataset` property.
    const dataContainer = document.getElementById('customer-container-data');
    let currentPage = parseInt(dataContainer.dataset.currentPage);
    const totalPages = parseInt(dataContainer.dataset.totalPages);
    const loginUrl = dataContainer.dataset.loginUrl;
    const addToCartUrl = dataContainer.dataset.addToCartUrl;

    const loadMoreBtn = document.getElementById('load-more-btn');
    const loader = document.getElementById('loader');
    const container = document.getElementById('cake-container');
    const loadMoreContainer = document.getElementById('load-more-container');

    if (loadMoreBtn) {
        loadMoreBtn.addEventListener('click', async () => {
            currentPage++;
            
            loader.style.display = 'block';
            loadMoreBtn.style.display = 'none';

            try {
                // Fetch the next page of cakes from our API
                const response = await fetch(`/api/get_cakes?page=${currentPage}`);
                const newCakes = await response.json();

                if (newCakes.length > 0) {
                    newCakes.forEach(cake => {
                        const cakeCardHTML = `
                        <div class="cake-card">
                            <div class="cake-card-image">
                                <img src="${cake.image}" alt="${cake.name}">
                            </div>
                            <div class="cake-card-content">
                                <h3>${cake.name}</h3>
                                <p>${cake.description}</p>
                                <p class="price">$${parseFloat(cake.price).toFixed(2)}</p>
                                <button
                                    class="order-button"
                                    data-name="${cake.name}"
                                    data-image="${cake.image}"
                                    data-price="${cake.price}"
                                    data-description="${cake.description}"
                                    onclick="addToCart(this)"
                                >
                                    <i class="fas fa-shopping-cart"></i> Add to Cart
                                </button>
                            </div>
                        </div>
                        `;
                        container.insertAdjacentHTML('beforeend', cakeCardHTML);
                    });
                }
                
                // Hide the button if we've reached the last page
                if (currentPage >= totalPages) {
                    loadMoreContainer.style.display = 'none';
                }

            } catch (error) {
                console.error('Failed to load more cakes:', error);
            } finally {
                loader.style.display = 'none';
                if (currentPage < totalPages) {
                    loadMoreBtn.style.display = 'block';
                }
            }
        });
    }

    // THE FIX: Use the JavaScript variables that hold the URLs.
    async function addToCart(button) {
        // We use the global variable from base.html to check login status
        if (!window.isUserAuthenticated) {
            alert("Please log in or create an account to add items to your cart.");
            window.location.href = loginUrl; // Use the variable
            return;
        }

        const product = {
            name: button.dataset.name,
            price: parseFloat(button.dataset.price),
            description: button.dataset.description,
            imageUrl: button.dataset.image
        };

        const response = await fetch(addToCartUrl, { // Use the variable
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(product)
        });
        
        if (response.ok) {
            alert(`'${product.name}' has been added to your cart!`);
            const cartCounter = document.getElementById('cart-count');
            // Safely parse the current count, defaulting to 0 if it's not a number
            const currentCount = parseInt(cartCounter.innerText) || 0;
            updateCartCounter(currentCount + 1);
        } else {
            alert("Could not add item to cart. Please try again.");
        }
    }
</script>
{% endblock %}

