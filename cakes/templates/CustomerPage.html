{% extends "base.html" %}

{% block title %}Our Cakes - FynCakes{% endblock %}

{% block head_extra %}
    <!-- All styling is now correctly handled by the external CSS file -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/customer.css') }}">
{% endblock %}

{% block content %}
<!--
THE FIX: We pass data from the server to JavaScript using data-* attributes
on this main container. This is a clean and safe way to avoid syntax errors.
-->
<div class="customer-container" 
     id="customer-container-data"
     data-current-page="{{ current_page }}"
     data-total-pages="{{ total_pages }}"
     data-selected-category="{{ selected_category or '' }}">

    <h1 class="page-title">
        <!-- The page title will now dynamically change based on the selected category -->
        {% if selected_category %}{{ selected_category }}{% else %}Our Cakes{% endif %}
    </h1>

    <div class="shop-layout">
        <!-- CATEGORY SIDEBAR -->
        <aside class="category-sidebar">
            <h3>Categories</h3>
            <ul class="category-list">
                <li class="{% if not selected_category %}active{% endif %}">
                    <a href="{{ url_for('routes.customer') }}">All Cakes</a>
                </li>
                {% for category in categories %}
                <li class="{% if category == selected_category %}active{% endif %}">
                    <a href="{{ url_for('routes.customer', category=category) }}">{{ category }}</a>
                </li>
                {% endfor %}
            </ul>
        </aside>

        <!-- PRODUCT GRID -->
        <main>
            <div class="product-grid" id="product-grid">
                {% if cakes %}
                    {% for cake in cakes %}
                    <a href="{{ url_for('routes.cake_details', cake_id=cake._id) }}" class="cake-card-link">
                        <div class="cake-card">
                            <div class="cake-card-image">
                                <img src="{{ cake.image }}" alt="{{ cake.name }}">
                            </div>
                            <div class="cake-card-content">
                                <h3>{{ cake.name }}</h3>
                                <p>{{ cake.description }}</p>
                                <p class="price">${{ "%.2f"|format(cake.price) }}</p>
                                <div class="order-button-wrapper">
                                    <span class="order-button">
                                        <i class="fas fa-search-plus"></i> View Details
                                    </span>
                                </div>
                            </div>
                        </div>
                    </a>
                    {% endfor %}
                {% else %}
                    <div class="no-cakes-message">
                        <h2>No cakes found in this category.</h2>
                        <p>Try selecting another category or view <a href="{{ url_for('routes.customer') }}">all our cakes</a>.</p>
                    </div>
                {% endif %}
            </div>

            <!-- 
                This uses a conditional 'hidden' class, which is a clean and reliable method.
            -->
            <div class="see-more-container {% if current_page >= total_pages %}hidden{% endif %}" id="see-more-container">
                <button class="see-more-btn" id="see-more-btn">See More</button>
                <div class="loader" id="loader" style="display: none;"></div>
            </div>
        </main>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // THE FIX: We now safely read the data from our container's `dataset` property.
    const dataContainer = document.getElementById('customer-container-data');
    let currentPage = parseInt(dataContainer.dataset.currentPage);
    const totalPages = parseInt(dataContainer.dataset.totalPages);
    const selectedCategory = dataContainer.dataset.selectedCategory;

    const seeMoreBtn = document.getElementById('see-more-btn');
    const loader = document.getElementById('loader');
    const container = document.getElementById('product-grid');
    const seeMoreContainer = document.getElementById('see-more-container');

    if (seeMoreBtn) {
        seeMoreBtn.addEventListener('click', async () => {
            currentPage++;
            
            loader.style.display = 'block';
            seeMoreBtn.style.display = 'none';

            try {
                let apiUrl = `/api/get_cakes?page=${currentPage}`;
                if (selectedCategory) {
                    apiUrl += `&category=${encodeURIComponent(selectedCategory)}`;
                }

                const response = await fetch(apiUrl);
                const newCakes = await response.json();

                if (newCakes.length > 0) {
                    newCakes.forEach(cake => {
                        const cakeCardHTML = `
                        <a href="${cake.url}" class="cake-card-link">
                            <div class="cake-card">
                                <div class="cake-card-image">
                                    <img src="${cake.image}" alt="${cake.name}">
                                </div>
                                <div class="cake-card-content">
                                    <h3>${cake.name}</h3>
                                    <p>${cake.description}</p>
                                    <p class="price">$${parseFloat(cake.price).toFixed(2)}</p>
                                    <div class="order-button-wrapper">
                                        <span class="order-button">
                                            <i class="fas fa-search-plus"></i> View Details
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </a>
                        `;
                        container.insertAdjacentHTML('beforeend', cakeCardHTML);
                    });
                }
                
                if (currentPage >= totalPages) {
                    seeMoreContainer.style.display = 'none';
                }

            } catch (error) {
                console.error('Failed to load more cakes:', error);
            } finally {
                loader.style.display = 'none';
                if (currentPage < totalPages) {
                    seeMoreBtn.style.display = 'block';
                }
            }
        });
    }
</script>
{% endblock %}

