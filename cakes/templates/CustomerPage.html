{% extends "base.html" %}

{% block title %}Our Cakes - FynCakes{% endblock %}

{% block head_extra %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/customer.css') }}">
    <style>
        /* This ensures your 4-column grid layout is active */
        .cake-container { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr); 
            gap: 1.5rem; 
        }
        @media (max-width: 1200px) { .cake-container { grid-template-columns: repeat(3, 1fr); } }
        @media (max-width: 900px) { .cake-container { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 600px) { .cake-container { grid-template-columns: 1fr; } }
    </style>
{% endblock %}

{% block content %}
<div class="customer-container">
    <h1 class="page-title">Our Cakes</h1>

    <div class="cake-container">
        {% for cake in cakes %}
        <div class="cake-card">
            <div class="cake-card-image">
                <img src="{{ cake.image }}" alt="{{ cake.name }}">
            </div>
            <div class="cake-card-content">
                <h3>{{ cake.name }}</h3>
                <p>{{ cake.description }}</p>
                <p class="price">${{ "%.2f"|format(cake.price) }}</p>
                <button
                    class="order-button"
                    data-name="{{ cake.name }}"
                    data-image="{{ cake.image }}"
                    data-price="{{ cake.price }}"
                    data-description="{{ cake.description }}"
                    onclick="addToCart(this)"
                >
                    <i class="fas fa-shopping-cart"></i> Add to Cart
                </button>
            </div>
        </div>
        {% else %}
        <div class="no-cakes-message">
            <h2>Our bakers are busy!</h2>
            <p>There are currently no cakes available. Please check back soon!</p>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // This new function sends the product data to our secure backend route.
    async function addToCart(button) {
        // Step 1: Create a product object from the button's data attributes.
        const product = {
            name: button.dataset.name,
            price: parseFloat(button.dataset.price),
            description: button.dataset.description,
            imageUrl: button.dataset.image
        };

        // Step 2: Send this product data to our new '/cart/add' backend endpoint.
        const response = await fetch("{{ url_for('routes.add_to_cart_db') }}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify(product)
        });

        // Step 3: Give feedback to the user and update the cart counter in the nav bar.
        if (response.ok) {
            alert(`'${product.name}' has been added to your cart!`);
            
            // Get the current number from the counter, add 1, and update it.
            const cartCounter = document.getElementById('cart-count');
            const currentCount = parseInt(cartCounter.innerText);
            updateCartCounter(currentCount + 1); // updateCartCounter is the global function from base.html
        } else {
            alert("Could not add item to cart. Please try again.");
        }
    }
</script>
{% endblock %}

