{% extends "base.html" %}

{% block title %}Complete Your Order - FynCakes{% endblock %}

{% block head_extra %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/checkout.css') }}">
{% endblock %}

{% block content %}
<div class="checkout-container">
    <h1 class="page-title">Complete Your Order</h1>

    <div class="checkout-layout">
        <!-- Column 1: Order Details & Payment Form -->
        <div class="order-form-section">
            <h3>1. Delivery Details</h3>
            <div class="form-group">
                <label for="delivery-date">Select Pickup/Delivery Date</label>
                <input type="date" id="delivery-date" class="form-control">
            </div>
            <div class="form-group">
                <label for="phone-number">Mobile Money Phone Number (e.g., 0772123456)</label>
                <input type="tel" id="phone-number" class="form-control" placeholder="Enter your MTN or Airtel number">
            </div>

            <h3>2. Payment Options</h3>
            <div class="payment-options">
                <div class="radio-option">
                    <input type="radio" id="pay-deposit" name="payment-option" value="deposit" checked>
                    <label for="pay-deposit">
                        <strong>Pay 80% Deposit Now</strong>
                        <span>Pay the rest on collection. (Only for orders at least 3 days in advance).</span>
                    </label>
                </div>
                <div class="radio-option">
                    <input type="radio" id="pay-full" name="payment-option" value="full">
                    <label for="pay-full">
                        <strong>Pay 100% Now</strong>
                        <span>Required for same-day or next-day orders.</span>
                    </label>
                </div>
            </div>
        </div>

        <!-- Column 2: Order Summary -->
        <div class="order-summary">
            <h3>Your Order</h3>
            <div id="summary-items-list">
                <!-- Summary items will be dynamically inserted here -->
            </div>
            <hr>
            <div class="summary-line">
                <span>Subtotal</span>
                <span id="cart-subtotal">$0.00</span>
            </div>
            <div class="summary-line">
                <strong>Amount to Pay Now</strong>
                <strong id="amount-to-pay">$0.00</strong>
            </div>
            <div class="summary-line remaining" id="balance-due-line" style="display: none;">
                <span>Balance Due on Collection</span>
                <span id="balance-due">$0.00</span>
            </div>
            <button class="confirm-purchase-btn" onclick="placeOrder()">
                <i class="fas fa-lock"></i> Place Order
            </button>
            <a href="{{ url_for('routes.customer') }}" class="continue-shopping-link">Back to Cakes</a>
        </div>
    </div>
</div>

<!-- Payment Processing Simulation Modal -->
<div id="payment-modal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
        <h4>Processing Payment...</h4>
        <p>In a real application, a prompt would be sent to your phone. Please wait for the simulation to complete.</p>
        <div class="spinner"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let selectedProducts = JSON.parse(localStorage.getItem("selectedProducts")) || [];
    let totalAmount = 0;

    function updateOrderSummary() {
        const summaryList = document.getElementById("summary-items-list");
        summaryList.innerHTML = "";
        totalAmount = selectedProducts.reduce((total, product) => total + product.price, 0);

        selectedProducts.forEach(product => {
            const item = document.createElement('div');
            item.className = 'summary-item';
            item.innerHTML = `<span>${product.name}</span><strong>$${product.price.toFixed(2)}</strong>`;
            summaryList.appendChild(item);
        });

        document.getElementById("cart-subtotal").innerText = `$${totalAmount.toFixed(2)}`;
        updateAmountToPay();
    }

    function updateAmountToPay() {
        const paymentOption = document.querySelector('input[name="payment-option"]:checked').value;
        const balanceDueLine = document.getElementById('balance-due-line');
        let amountToPay = totalAmount;
        let balanceDue = 0;

        if (paymentOption === 'deposit') {
            amountToPay = totalAmount * 0.8;
            balanceDue = totalAmount * 0.2;
            balanceDueLine.style.display = 'flex';
        } else {
            balanceDueLine.style.display = 'none';
        }

        document.getElementById("amount-to-pay").innerText = `$${amountToPay.toFixed(2)}`;
        document.getElementById("balance-due").innerText = `$${balanceDue.toFixed(2)}`;
    }

    function placeOrder() {
        const deliveryDate = document.getElementById('delivery-date').value;
        const phoneNumber = document.getElementById('phone-number').value;
        const paymentOption = document.querySelector('input[name="payment-option"]:checked').value;

        // --- Validation ---
        if (selectedProducts.length === 0) {
            alert("Your cart is empty!");
            return;
        }
        if (!deliveryDate) {
            alert("Please select a delivery date.");
            return;
        }
        if (!phoneNumber || !/^(07)\d{8}$/.test(phoneNumber)) {
            alert("Please enter a valid Ugandan mobile number (e.g., 0772123456).");
            return;
        }

        const modal = document.getElementById('payment-modal');
        modal.style.display = 'flex';

        const orderData = {
            products: selectedProducts,
            totalAmount: totalAmount,
            deliveryDate: deliveryDate,
            phoneNumber: phoneNumber,
            paymentOption: paymentOption,
        };
        
        // --- SIMULATION ---
        // In a real app, this is where you'd call your backend to trigger the payment API.
        setTimeout(() => {
            fetch("{{ url_for('routes.place_order') }}", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(orderData),
            })
            .then(response => response.json())
            .then(data => {
                modal.style.display = 'none';
                if (data.success) {
                    alert(data.message);
                    localStorage.removeItem("selectedProducts");
                    window.location.href = "{{ url_for('routes.customer') }}"; // Or a 'my orders' page
                } else {
                    alert("There was an error placing your order. Please try again.");
                }
            })
            .catch(error => {
                modal.style.display = 'none';
                console.error("Error:", error);
            });
        }, 3000); // Simulate a 3-second payment processing time
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', () => {
        // Set minimum date for date picker to today
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('delivery-date').setAttribute('min', today);

        // Add event listeners for payment options
        document.querySelectorAll('input[name="payment-option"]').forEach(radio => {
            radio.addEventListener('change', updateAmountToPay);
        });

        updateOrderSummary();
    });
</script>
{% endblock %}

