{% extends "base.html" %}

{% block title %}Complete Your Order - FynCakes{% endblock %}

{% block head_extra %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/checkout.css') }}">
{% endblock %}

{% block content %}
<div class="checkout-container">
    <h1 class="page-title">Complete Your Order</h1>

    <div class="checkout-layout">
        <!-- Column 1: Delivery Details Form -->
        <div class="order-form-section">
            <h3>Delivery Details</h3>
            <p class="form-subtitle">Please provide your details to proceed.</p>
            <div class="form-group">
                <label for="delivery-date">Select Pickup/Delivery Date</label>
                <input type="date" id="delivery-date" class="form-control">
            </div>
            <div class="form-group">
                <label for="phone-number">Contact Phone Number (for order updates)</label>
                <input type="tel" id="phone-number" class="form-control" placeholder="e.g., 0772123456">
            </div>
        </div>

        <!-- Column 2: Order Summary Card -->
        <div class="order-summary">
            <h3>Your Order Summary</h3>
            <div id="summary-items-list">
                <!-- JavaScript will populate this with items from the cart -->
            </div>
            <hr>
            <div class="summary-line total">
                <strong>Total Amount</strong>
                <strong id="cart-total">$0.00</strong>
            </div>
            <button class="confirm-purchase-btn" onclick="placeOrder()">
                <i class="fas fa-check-circle"></i> Place Order & Pay on Delivery
            </button>
            <a href="{{ url_for('routes.cart') }}" class="back-link">Back to Cart</a>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div id="loading-modal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
        <h4>Placing Your Order...</h4>
        <div class="spinner"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // This script now starts by reading the cart data passed from the cart page.
    const checkoutCart = JSON.parse(sessionStorage.getItem("checkoutCart")) || [];
    let totalAmount = 0;

    function updateOrderSummary() {
        const summaryList = document.getElementById("summary-items-list");
        summaryList.innerHTML = "";
        
        totalAmount = checkoutCart.reduce((total, product) => total + product.price, 0);

        if (checkoutCart.length > 0) {
            checkoutCart.forEach(product => {
                const item = document.createElement('div');
                item.className = 'summary-item';
                item.innerHTML = `<span>${product.name}</span><strong>$${product.price.toFixed(2)}</strong>`;
                summaryList.appendChild(item);
            });
        } else {
             summaryList.innerHTML = "<p>Your cart is empty.</p>";
        }
        
        document.getElementById("cart-total").innerText = `$${totalAmount.toFixed(2)}`;
    }

    async function placeOrder() {
        const deliveryDate = document.getElementById('delivery-date').value;
        const phoneNumber = document.getElementById('phone-number').value;

        // --- Validation ---
        if (checkoutCart.length === 0) {
            alert("Your cart is empty!");
            window.location.href = "{{ url_for('routes.customer') }}";
            return;
        }
        if (!deliveryDate) {
            alert("Please select a delivery or pickup date.");
            return;
        }
        if (!phoneNumber || !/^(07)\d{8}$/.test(phoneNumber)) {
            alert("Please enter a valid Ugandan mobile number (e.g., 0772123456).");
            return;
        }

        const modal = document.getElementById('loading-modal');
        modal.style.display = 'flex';

        const orderData = {
            products: checkoutCart,
            totalAmount: totalAmount,
            deliveryDate: deliveryDate,
            phoneNumber: phoneNumber
        };
        
        // --- Call the backend to place the order and send the email ---
        try {
            const response = await fetch("{{ url_for('routes.place_order') }}", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(orderData),
            });
            const data = await response.json();

            modal.style.display = 'none';

            if (data.success) {
                alert(data.message); // Show the success message from the server
                // Clear the cart from the database
                await fetch("{{ url_for('routes.clear_cart') }}", { method: 'POST' });
                sessionStorage.removeItem('checkoutCart');
                window.location.href = "{{ url_for('routes.customer') }}";
            } else {
                alert(data.message || "There was an error placing your order. Please try again.");
            }
        } catch (error) {
            modal.style.display = 'none';
            console.error("Error:", error);
            alert("An unexpected error occurred. Please check your connection.");
        }
    }

    // Initialize the page
    document.addEventListener('DOMContentLoaded', () => {
        // Set minimum date for date picker to today
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('delivery-date').setAttribute('min', today);
        
        updateOrderSummary();
    });
</script>
{% endblock %}

