<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{% block title %}FynCakes{% endblock %}</title>
    
    <!-- Professional Google Font & Icons with Performance Optimization -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" media="print" onload="this.media='all'">
    
    <!-- Performance Optimization Meta Tags -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="FynCakes - Premium handcrafted cakes in Kampala. Fresh ingredients, beautiful designs, and exceptional taste for your special occasions.">
    <meta name="keywords" content="cakes, bakery, Kampala, Uganda, wedding cakes, birthday cakes, custom cakes, fresh ingredients">
    <meta name="author" content="FynCakes">
    
    <!-- Open Graph Meta Tags for Social Sharing -->
    <meta property="og:title" content="FynCakes - Premium Handcrafted Cakes">
    <meta property="og:description" content="Where every slice is a piece of art, crafted with passion. Fresh, delicious cakes for your special moments.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="{{ request.url }}">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    
    <!-- Main Stylesheet -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    
    <!-- A block for extra head elements on specific pages -->
    {% block head_extra %}{% endblock %}
</head>
<body>
    <header class="main-header">
        <nav class="navbar">
            <a href="{{ url_for('routes.home') }}" class="nav-brand">FynCakes</a>
            <button class="nav-toggle" id="nav-toggle" aria-label="toggle navigation">
                <span class="hamburger"></span>
            </button>
            <div class="nav-menu" id="nav-menu">
                <a href="{{ url_for('routes.home') }}" class="nav-link">Home</a>
                <a href="{{ url_for('routes.customer') }}" class="nav-link">Our Cakes</a>
                <a href="{{ url_for('routes.about_us') }}" class="nav-link">About</a>
                {% if current_user.is_authenticated and current_user.role == 'admin' %}
                    <a href="{{ url_for('routes.admin_dashboard') }}" class="nav-link">Admin</a>
                {% endif %}
            </div>
            <div class="nav-actions">
                <a href="{{ url_for('routes.cart') }}" class="nav-link cart-link" aria-label="Shopping Cart">
                    <i class="fas fa-shopping-cart"></i>
                    <span id="cart-count" class="cart-count-badge">0</span>
                </a>
                {% if current_user.is_authenticated %}
                    <div class="user-menu">
                        <span class="welcome-text">Hi, {{ current_user.first_name or current_user.username }}!</span>
                        <div class="user-dropdown">
                            <button class="user-dropdown-toggle" aria-label="User Menu">
                                <i class="fas fa-user-circle"></i>
                                <i class="fas fa-chevron-down"></i>
                            </button>
                            <div class="user-dropdown-menu">
                                <a href="{{ url_for('routes.customer_dashboard') }}" class="dropdown-item">
                                    <i class="fas fa-tachometer-alt"></i> Dashboard
                                </a>
                                <a href="{{ url_for('routes.customer_profile') }}" class="dropdown-item">
                                    <i class="fas fa-user-edit"></i> Profile
                                </a>
                                <a href="{{ url_for('routes.order_history') }}" class="dropdown-item">
                                    <i class="fas fa-history"></i> Order History
                                </a>
                                <a href="{{ url_for('routes.wishlist_page') }}" class="dropdown-item">
                                    <i class="fas fa-heart"></i> My Wishlist
                                </a>
                                <div class="dropdown-divider"></div>
                                <a href="{{ url_for('routes.logout') }}" class="dropdown-item">
                                    <i class="fas fa-sign-out-alt"></i> Logout
                                </a>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <a href="{{ url_for('routes.login') }}" class="nav-link nav-button">Login</a>
                {% endif %}
            </div>
        </nav>
    </header>

    <main class="main-content">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="flash-messages-container">
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }}">{{ message }}</div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}
        
        <!-- Main content from child templates will be injected here -->
        {% block content %}{% endblock %}
    </main>

    <!-- Live Chat Widget -->
    <div id="chat-widget" class="chat-widget">
        <div id="chat-toggle" class="chat-toggle">
            <i class="fas fa-comments"></i>
            <span class="chat-badge" id="chat-badge" style="display: none;">1</span>
        </div>
        <div id="chat-container" class="chat-container" style="display: none;">
            <div class="chat-header">
                <div class="chat-title">
                    <i class="fas fa-robot"></i>
                    <span>FynCakes Assistant</span>
                </div>
                <button id="chat-close" class="chat-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="chat-messages" class="chat-messages">
                <div class="chat-message bot-message">
                    <div class="message-avatar">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="message-content">
                        <p>Hello! I'm your FynCakes assistant. How can I help you today? I can answer questions about our cakes, help with orders, or provide recommendations!</p>
                    </div>
                </div>
            </div>
            <div class="chat-input-container">
                <input type="text" id="chat-input" placeholder="Type your message..." maxlength="500">
                <button id="chat-send" class="chat-send">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- NEW: Enhanced & Professional Footer -->
    <footer class="main-footer">
        <div class="footer-content">
            <div class="footer-section">
                <h4>FynCakes</h4>
                <p>Crafting Kampala's most delicious cakes with love and passion. From our family to yours.</p>
            </div>
            <div class="footer-section">
                <h4>Quick Links</h4>
                <ul>
                    <li><a href="{{ url_for('routes.home') }}">Home</a></li>
                    <li><a href="{{ url_for('routes.customer') }}">Our Cakes</a></li>
                    <li><a href="{{ url_for('routes.about_us') }}">About Us</a></li>
                    <li><a href="{{ url_for('routes.terms_of_service') }}">Terms of Service</a></li>
                </ul>
            </div>
            <div class="footer-section">
                <h4>Contact & Connect</h4>
                <ul>
                    <li><i class="fas fa-envelope"></i> <a href="mailto:fyncakes1@gmail.com">fyncakes1@gmail.com</a></li>
                    <li><i class="fab fa-whatsapp"></i> <a href="https://whatsapp.com/channel/0029VbA3JDC0gcfS8j3tMW2t" target="_blank">Join our WhatsApp Channel</a></li>
                    <li><i class="fas fa-phone"></i> Orders: 0758 449 390</li>
                </ul>
            </div>
        </div>
        <div class="footer-bottom">
             &copy; <span id="current-year"></span> FynCakes. All rights reserved.
        </div>
    </footer>

    <!-- NEW: Floating WhatsApp Support Widget -->
    <a href="https://wa.me/256751082492" class="whatsapp-support-widget" target="_blank" aria-label="Chat with us on WhatsApp">
        <i class="fab fa-whatsapp"></i>
    </a>

    <!-- Global JavaScript Logic -->
    <script>
        // --- Mobile Navigation Toggle Logic ---
        const navToggle = document.getElementById('nav-toggle');
        const navMenu = document.getElementById('nav-menu');

        if (navToggle) {
            navToggle.addEventListener('click', () => {
                navMenu.classList.toggle('active');
                navToggle.classList.toggle('active');
            });
        }
        
        // --- Global Cart Counter Update Function ---
        function updateCartCounter(count) {
            const cartCounter = document.getElementById('cart-count');
            if(cartCounter) {
                cartCounter.innerText = count;
                cartCounter.style.display = count > 0 ? 'flex' : 'none';
            }
        }
        
        // --- Scripts to run when the page is fully loaded ---
        document.addEventListener('DOMContentLoaded', () => {
            // Set the current year in the footer
            document.getElementById('current-year').textContent = new Date().getFullYear();

            // Fetch initial cart count if the user is logged in
            if (window.isUserAuthenticated) {
                fetch(window.getCartUrl)
                    .then(response => response.ok ? response.json() : Promise.reject('Failed to fetch'))
                    .then(data => updateCartCounter(data.length))
                    .catch(error => console.error('Error fetching cart count:', error));
            } else {
                updateCartCounter(0);
            }
        });
    </script>
    
    <!-- This block safely injects server-side data into global JavaScript variables -->
    {% if current_user.is_authenticated %}
    <script>
        window.isUserAuthenticated = true;
        window.getCartUrl = "{{ url_for('routes.get_cart_items') }}";
    </script>
    {% else %}
    <script>
        window.isUserAuthenticated = false;
        window.getCartUrl = null;
    </script>
    {% endif %}
    
    <!-- Live Chat Widget JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const chatToggle = document.getElementById('chat-toggle');
            const chatContainer = document.getElementById('chat-container');
            const chatClose = document.getElementById('chat-close');
            const chatInput = document.getElementById('chat-input');
            const chatSend = document.getElementById('chat-send');
            const chatMessages = document.getElementById('chat-messages');
            const chatBadge = document.getElementById('chat-badge');
            
            let isOpen = false;
            let messageCount = 0;
            
            // Toggle chat
            chatToggle.addEventListener('click', function() {
                isOpen = !isOpen;
                chatContainer.style.display = isOpen ? 'flex' : 'none';
                if (isOpen) {
                    chatBadge.style.display = 'none';
                    messageCount = 0;
                    chatInput.focus();
                }
            });
            
            // Close chat
            chatClose.addEventListener('click', function() {
                isOpen = false;
                chatContainer.style.display = 'none';
            });
            
            // Send message
            function sendMessage() {
                const message = chatInput.value.trim();
                if (!message) return;
                
                // Add user message
                addMessage(message, 'user');
                chatInput.value = '';
                
                // Simulate typing indicator
                setTimeout(() => {
                    const response = getAIResponse(message);
                    addMessage(response, 'bot');
                }, 1000);
            }
            
            // Send button click
            chatSend.addEventListener('click', sendMessage);
            
            // Enter key press
            chatInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            
            // Add message to chat
            function addMessage(text, sender) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `chat-message ${sender}-message`;
                
                const avatar = document.createElement('div');
                avatar.className = 'message-avatar';
                avatar.innerHTML = sender === 'bot' ? '<i class="fas fa-robot"></i>' : '<i class="fas fa-user"></i>';
                
                const content = document.createElement('div');
                content.className = 'message-content';
                content.innerHTML = `<p>${text}</p>`;
                
                messageDiv.appendChild(avatar);
                messageDiv.appendChild(content);
                chatMessages.appendChild(messageDiv);
                
                // Scroll to bottom
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                // Show badge if chat is closed
                if (!isOpen && sender === 'bot') {
                    messageCount++;
                    chatBadge.textContent = messageCount;
                    chatBadge.style.display = 'flex';
                }
            }
            
            // AI Response Logic
            function getAIResponse(message) {
                const lowerMessage = message.toLowerCase();
                
                // Greetings
                if (lowerMessage.includes('hello') || lowerMessage.includes('hi') || lowerMessage.includes('hey')) {
                    return "Hello! Welcome to FynCakes! 🎂 I'm here to help you with any questions about our delicious cakes. What would you like to know?";
                }
                
                // Cake questions
                if (lowerMessage.includes('cake') || lowerMessage.includes('cakes')) {
                    if (lowerMessage.includes('flavor') || lowerMessage.includes('flavors')) {
                        return "We offer a wide variety of cake flavors including chocolate, vanilla, strawberry, red velvet, carrot, and many more! You can browse our full collection on our cakes page. Which flavor interests you most?";
                    }
                    if (lowerMessage.includes('price') || lowerMessage.includes('cost') || lowerMessage.includes('how much')) {
                        return "Our cakes are priced based on size and complexity. Prices start from Shs 50,000 for small cakes. You can see specific prices for each cake on our website. Would you like me to help you find a cake in your budget?";
                    }
                    if (lowerMessage.includes('order') || lowerMessage.includes('buy')) {
                        return "Great! You can easily order any cake by clicking the 'Add to Cart' button on any cake page. We also offer custom orders for special occasions. What type of cake are you looking for?";
                    }
                    if (lowerMessage.includes('delivery') || lowerMessage.includes('deliver')) {
                        return "We offer delivery services throughout Kampala! Delivery is usually within 2-4 hours for regular orders. For custom cakes, we'll coordinate the delivery time with you. What's your location?";
                    }
                    return "We have an amazing selection of cakes! From birthday cakes to wedding cakes, we've got something for every occasion. You can browse our collection or tell me what you're looking for and I'll help you find the perfect cake!";
                }
                
                // Order questions
                if (lowerMessage.includes('order') || lowerMessage.includes('purchase')) {
                    return "Ordering is easy! Simply browse our cakes, click 'Add to Cart' on any cake you like, and proceed to checkout. We accept various payment methods and offer delivery throughout Kampala. Need help with a specific order?";
                }
                
                // Contact questions
                if (lowerMessage.includes('contact') || lowerMessage.includes('phone') || lowerMessage.includes('email')) {
                    return "You can reach us at:\n📞 Phone: 0758 449 390\n📧 Email: fyncakes1@gmail.com\n💬 WhatsApp: Join our channel for updates!\nWe're here to help with any questions!";
                }
                
                // Location questions
                if (lowerMessage.includes('where') || lowerMessage.includes('location') || lowerMessage.includes('address')) {
                    return "We're located in Kampala, Uganda! We offer delivery services throughout the city. You can place orders online and we'll deliver fresh cakes right to your doorstep. What area are you in?";
                }
                
                // Custom cake questions
                if (lowerMessage.includes('custom') || lowerMessage.includes('special') || lowerMessage.includes('wedding') || lowerMessage.includes('birthday')) {
                    return "We love creating custom cakes for special occasions! We can make wedding cakes, birthday cakes, anniversary cakes, and more. Tell me about your special event and I'll help you plan the perfect cake!";
                }
                
                // General help
                if (lowerMessage.includes('help') || lowerMessage.includes('what can you do')) {
                    return "I can help you with:\n🍰 Finding the perfect cake\n💰 Pricing information\n📦 Ordering and delivery\n🎉 Custom cake requests\n📞 Contact information\n\nWhat would you like to know?";
                }
                
                // Thank you responses
                if (lowerMessage.includes('thank') || lowerMessage.includes('thanks')) {
                    return "You're very welcome! 😊 I'm here whenever you need help with anything related to FynCakes. Is there anything else I can assist you with?";
                }
                
                // Default response
                return "That's a great question! I'd be happy to help you with that. Could you provide a bit more detail? I can assist with cake recommendations, ordering, delivery, pricing, or any other FynCakes-related questions!";
            }
        });
    </script>

    <!-- A block for extra scripts on specific pages -->
    {% block scripts %}{% endblock %}
</body>
</html>

